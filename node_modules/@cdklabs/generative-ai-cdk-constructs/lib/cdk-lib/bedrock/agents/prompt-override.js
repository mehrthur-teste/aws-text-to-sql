"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PromptOverrideConfiguration = exports.AgentStepType = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const validation = require("../../../common/helpers/validation-helpers");
/**
 * The step in the agent sequence where to set a specific prompt configuration.
 */
var AgentStepType;
(function (AgentStepType) {
    AgentStepType["PRE_PROCESSING"] = "PRE_PROCESSING";
    AgentStepType["ORCHESTRATION"] = "ORCHESTRATION";
    AgentStepType["POST_PROCESSING"] = "POST_PROCESSING";
    AgentStepType["KNOWLEDGE_BASE_RESPONSE_GENERATION"] = "KNOWLEDGE_BASE_RESPONSE_GENERATION";
})(AgentStepType || (exports.AgentStepType = AgentStepType = {}));
class PromptOverrideConfiguration {
    static fromSteps(steps) {
        // Create new object
        return new PromptOverrideConfiguration({ steps });
    }
    /**
     * Creates a PromptOverrideConfiguration with a custom Lambda parser function.
     * @param props Configuration including:
     *   - `parser`: Lambda function to use as custom parser
     *   - `steps`: prompt step configurations. At least one of the steps must make use of the custom parser.
     */
    static withCustomParser(props) {
        // Create new object
        return new PromptOverrideConfiguration(props);
    }
    /**
     * Create a new PromptOverrideConfiguration.
     *
     * @internal - This is marked as private so end users leverage it only through static methods
     */
    constructor(props) {
        this.validateInferenceConfig = (config) => {
            const errors = [];
            if (config) {
                if (config.temperature < 0 || config.temperature > 1) {
                    errors.push('Temperature must be between 0 and 1');
                }
                if (config.topP < 0 || config.topP > 1) {
                    errors.push('TopP must be between 0 and 1');
                }
                if (config.topK < 0 || config.topK > 500) {
                    errors.push('TopK must be between 0 and 500');
                }
                if (config.stopSequences.length > 4) {
                    errors.push('Maximum 4 stop sequences allowed');
                }
                if (config.maximumLength < 0 || config.maximumLength > 4096) {
                    errors.push('MaximumLength must be between 0 and 4096');
                }
            }
            return errors;
        };
        this.validateSteps = (steps) => {
            const errors = [];
            if (!steps || steps.length === 0) {
                errors.push('Steps array cannot be empty');
            }
            // Validate each step's inference config
            steps?.forEach(step => {
                const inferenceErrors = this.validateInferenceConfig(step.inferenceConfig);
                if (inferenceErrors.length > 0) {
                    errors.push(`Step ${step.stepType}: ${inferenceErrors.join(', ')}`);
                }
            });
            return errors;
        };
        this.validateCustomParser = (steps) => {
            const errors = [];
            const hasCustomParser = steps?.some(step => step.useCustomParser);
            if (!hasCustomParser) {
                errors.push('At least one step must use custom parser');
            }
            return errors;
        };
        // Validate props
        validation.throwIfInvalid(this.validateSteps, props.steps);
        if (props.parser) {
            validation.throwIfInvalid(this.validateCustomParser, props.steps);
        }
        this.parser = props.parser;
        this.steps = props.steps;
    }
    /**
     * Format as CfnAgent.PromptOverrideConfigurationProperty
     *
     * @internal This is an internal core function and should not be called directly.
     */
    _render() {
        return {
            overrideLambda: this.parser?.functionArn,
            promptConfigurations: this.steps?.map(step => ({
                // prettier-ignore
                promptType: step.stepType,
                /** Maps stepEnabled (true → 'ENABLED', false → 'DISABLED', undefined → undefined (uses CFN DEFAULT)) */
                promptState: step?.stepEnabled === undefined ? undefined : step.stepEnabled ? 'ENABLED' : 'DISABLED',
                /** Maps stepEnabled (true → 'OVERRIDDEN', false → 'DEFAULT', undefined → undefined (uses CFN DEFAULT)) */
                // prettier-ignore
                parserMode: step?.useCustomParser === undefined
                    ? undefined
                    : step?.useCustomParser ? 'OVERRIDDEN' : 'DEFAULT',
                // Use custom prompt template if provided, otherwise use default
                // prettier-ignore
                promptCreationMode: step?.customPromptTemplate === undefined
                    ? undefined
                    : step?.customPromptTemplate ? 'OVERRIDDEN' : 'DEFAULT',
                basePromptTemplate: step.customPromptTemplate,
                inferenceConfiguration: step.inferenceConfig,
            })) || [],
        };
    }
}
exports.PromptOverrideConfiguration = PromptOverrideConfiguration;
_a = JSII_RTTI_SYMBOL_1;
PromptOverrideConfiguration[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.PromptOverrideConfiguration", version: "0.1.293" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbXB0LW92ZXJyaWRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9hZ2VudHMvcHJvbXB0LW92ZXJyaWRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBZUEseUVBQXlFO0FBRXpFOztHQUVHO0FBQ0gsSUFBWSxhQUtYO0FBTEQsV0FBWSxhQUFhO0lBQ3ZCLGtEQUFpQyxDQUFBO0lBQ2pDLGdEQUErQixDQUFBO0lBQy9CLG9EQUFtQyxDQUFBO0lBQ25DLDBGQUF5RSxDQUFBO0FBQzNFLENBQUMsRUFMVyxhQUFhLDZCQUFiLGFBQWEsUUFLeEI7QUFrSEQsTUFBYSwyQkFBMkI7SUFDL0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFpQztRQUN2RCxvQkFBb0I7UUFDcEIsT0FBTyxJQUFJLDJCQUEyQixDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsS0FBd0I7UUFDckQsb0JBQW9CO1FBQ3BCLE9BQU8sSUFBSSwyQkFBMkIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBd0JEOzs7O09BSUc7SUFDSCxZQUFvQixLQUF3QjtRQXlDcEMsNEJBQXVCLEdBQUcsQ0FBQyxNQUErQixFQUFZLEVBQUU7WUFDOUUsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO1lBRTVCLElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7Z0JBQ3JELENBQUM7Z0JBQ0QsSUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDO29C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LElBQUksRUFBRSxXQUFXLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsVUFBVTtnQkFDcEcsMEdBQTBHO2dCQUMxRyxrQkFBa0I7Z0JBQ2xCLFVBQVUsRUFDUixJQUFJLEVBQUUsZUFBZSxLQUFLLFNBQVM7b0JBQ2pDLENBQUMsQ0FBQyxTQUFTO29CQUNYLENBQUMsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVM7Z0JBQ3RELGdFQUFnRTtnQkFDaEUsa0JBQWtCO2dCQUNsQixrQkFBa0IsRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEtBQUssU0FBUztvQkFDMUQsQ0FBQyxDQUFDLFNBQVM7b0JBQ1gsQ0FBQyxDQUFDLElBQUksRUFBRSxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTO2dCQUN6RCxrQkFBa0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CO2dCQUM3QyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsZUFBZTthQUM3QyxDQUFDLENBQUMsSUFBSSxFQUFFO1NBQ1osQ0FBQztJQUNKLENBQUM7O0FBbEZILGtFQXdJQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENmbkFnZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWJlZHJvY2snO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyB2YWxpZGF0aW9uIGZyb20gJy4uLy4uLy4uL2NvbW1vbi9oZWxwZXJzL3ZhbGlkYXRpb24taGVscGVycyc7XG5cbi8qKlxuICogVGhlIHN0ZXAgaW4gdGhlIGFnZW50IHNlcXVlbmNlIHdoZXJlIHRvIHNldCBhIHNwZWNpZmljIHByb21wdCBjb25maWd1cmF0aW9uLlxuICovXG5leHBvcnQgZW51bSBBZ2VudFN0ZXBUeXBlIHtcbiAgUFJFX1BST0NFU1NJTkcgPSAnUFJFX1BST0NFU1NJTkcnLFxuICBPUkNIRVNUUkFUSU9OID0gJ09SQ0hFU1RSQVRJT04nLFxuICBQT1NUX1BST0NFU1NJTkcgPSAnUE9TVF9QUk9DRVNTSU5HJyxcbiAgS05PV0xFREdFX0JBU0VfUkVTUE9OU0VfR0VORVJBVElPTiA9ICdLTk9XTEVER0VfQkFTRV9SRVNQT05TRV9HRU5FUkFUSU9OJyxcbn1cblxuLyoqXG4gKiBMTE0gaW5mZXJlbmNlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmZlcmVuY2VDb25maWd1cmF0aW9uIHtcbiAgLyoqXG4gICAqIFRoZSBsaWtlbGlob29kIG9mIHRoZSBtb2RlbCBzZWxlY3RpbmcgaGlnaGVyLXByb2JhYmlsaXR5IG9wdGlvbnMgd2hpbGVcbiAgICogZ2VuZXJhdGluZyBhIHJlc3BvbnNlLiBBIGxvd2VyIHZhbHVlIG1ha2VzIHRoZSBtb2RlbCBtb3JlIGxpa2VseSB0byBjaG9vc2VcbiAgICogaGlnaGVyLXByb2JhYmlsaXR5IG9wdGlvbnMsIHdoaWxlIGEgaGlnaGVyIHZhbHVlIG1ha2VzIHRoZSBtb2RlbCBtb3JlXG4gICAqIGxpa2VseSB0byBjaG9vc2UgbG93ZXItcHJvYmFiaWxpdHkgb3B0aW9ucy5cbiAgICpcbiAgICogRmxvYXRpbmcgcG9pbnRcbiAgICpcbiAgICogbWluIDBcbiAgICogbWF4IDFcbiAgICovXG4gIHJlYWRvbmx5IHRlbXBlcmF0dXJlOiBudW1iZXI7XG4gIC8qKlxuICAgKiBXaGlsZSBnZW5lcmF0aW5nIGEgcmVzcG9uc2UsIHRoZSBtb2RlbCBkZXRlcm1pbmVzIHRoZSBwcm9iYWJpbGl0eSBvZiB0aGVcbiAgICogZm9sbG93aW5nIHRva2VuIGF0IGVhY2ggcG9pbnQgb2YgZ2VuZXJhdGlvbi4gVGhlIHZhbHVlIHRoYXQgeW91IHNldCBmb3JcbiAgICogVG9wIFAgZGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIG1vc3QtbGlrZWx5IGNhbmRpZGF0ZXMgZnJvbSB3aGljaCB0aGUgbW9kZWxcbiAgICogY2hvb3NlcyB0aGUgbmV4dCB0b2tlbiBpbiB0aGUgc2VxdWVuY2UuIEZvciBleGFtcGxlLCBpZiB5b3Ugc2V0IHRvcFAgdG9cbiAgICogODAsIHRoZSBtb2RlbCBvbmx5IHNlbGVjdHMgdGhlIG5leHQgdG9rZW4gZnJvbSB0aGUgdG9wIDgwJSBvZiB0aGVcbiAgICogcHJvYmFiaWxpdHkgZGlzdHJpYnV0aW9uIG9mIG5leHQgdG9rZW5zLlxuICAgKlxuICAgKiBGbG9hdGluZyBwb2ludFxuICAgKlxuICAgKiBtaW4gMFxuICAgKiBtYXggMVxuICAgKi9cbiAgcmVhZG9ubHkgdG9wUDogbnVtYmVyO1xuICAvKipcbiAgICogV2hpbGUgZ2VuZXJhdGluZyBhIHJlc3BvbnNlLCB0aGUgbW9kZWwgZGV0ZXJtaW5lcyB0aGUgcHJvYmFiaWxpdHkgb2YgdGhlXG4gICAqIGZvbGxvd2luZyB0b2tlbiBhdCBlYWNoIHBvaW50IG9mIGdlbmVyYXRpb24uIFRoZSB2YWx1ZSB0aGF0IHlvdSBzZXQgZm9yXG4gICAqIHRvcEsgaXMgdGhlIG51bWJlciBvZiBtb3N0LWxpa2VseSBjYW5kaWRhdGVzIGZyb20gd2hpY2ggdGhlIG1vZGVsIGNob29zZXNcbiAgICogdGhlIG5leHQgdG9rZW4gaW4gdGhlIHNlcXVlbmNlLiBGb3IgZXhhbXBsZSwgaWYgeW91IHNldCB0b3BLIHRvIDUwLCB0aGVcbiAgICogbW9kZWwgc2VsZWN0cyB0aGUgbmV4dCB0b2tlbiBmcm9tIGFtb25nIHRoZSB0b3AgNTAgbW9zdCBsaWtlbHkgY2hvaWNlcy5cbiAgICpcbiAgICogSW50ZWdlclxuICAgKlxuICAgKiBtaW4gMFxuICAgKiBtYXggNTAwXG4gICAqL1xuICByZWFkb25seSB0b3BLOiBudW1iZXI7XG4gIC8qKlxuICAgKiBBIGxpc3Qgb2Ygc3RvcCBzZXF1ZW5jZXMuIEEgc3RvcCBzZXF1ZW5jZSBpcyBhIHNlcXVlbmNlIG9mIGNoYXJhY3RlcnMgdGhhdFxuICAgKiBjYXVzZXMgdGhlIG1vZGVsIHRvIHN0b3AgZ2VuZXJhdGluZyB0aGUgcmVzcG9uc2UuXG4gICAqXG4gICAqIGxlbmd0aCAwLTRcbiAgICovXG4gIHJlYWRvbmx5IHN0b3BTZXF1ZW5jZXM6IHN0cmluZ1tdO1xuICAvKipcbiAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIHRva2VucyB0byBnZW5lcmF0ZSBpbiB0aGUgcmVzcG9uc2UuXG4gICAqXG4gICAqIEludGVnZXJcbiAgICpcbiAgICogbWluIDBcbiAgICogbWF4IDQwOTZcbiAgICovXG4gIHJlYWRvbmx5IG1heGltdW1MZW5ndGg6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDb250YWlucyBjb25maWd1cmF0aW9ucyB0byBvdmVycmlkZSBhIHByb21wdCB0ZW1wbGF0ZSBpbiBvbmUgcGFydCBvZiBhbiBhZ2VudCBzZXF1ZW5jZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbiB7XG4gIC8qKlxuICAgKiBUaGUgc3RlcCBpbiB0aGUgYWdlbnQgc2VxdWVuY2Ugd2hlcmUgdG8gc2V0IGEgc3BlY2lmaWMgcHJvbXB0IGNvbmZpZ3VyYXRpb24uXG4gICAqL1xuICByZWFkb25seSBzdGVwVHlwZTogQWdlbnRTdGVwVHlwZTtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZW5hYmxlIG9yIHNraXAgdGhpcyBzdGVwIGluIHRoZSBhZ2VudCBzZXF1ZW5jZS5cbiAgICogQGRlZmF1bHQgLSBUaGUgZGVmYXVsdCBzdGF0ZSBmb3IgZWFjaCBzdGVwIHR5cGUgaXMgYXMgZm9sbG93cy5cbiAgICpcbiAgICogICAgIFBSRV9QUk9DRVNTSU5HIOKAkyBFTkFCTEVEXG4gICAqICAgICBPUkNIRVNUUkFUSU9OIOKAkyBFTkFCTEVEXG4gICAqICAgICBLTk9XTEVER0VfQkFTRV9SRVNQT05TRV9HRU5FUkFUSU9OIOKAkyBFTkFCTEVEXG4gICAqICAgICBQT1NUX1BST0NFU1NJTkcg4oCTIERJU0FCTEVEXG4gICAqL1xuICByZWFkb25seSBzdGVwRW5hYmxlZD86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBUaGUgY3VzdG9tIHByb21wdCB0ZW1wbGF0ZSB0byBiZSB1c2VkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFRoZSBkZWZhdWx0IHByb21wdCB0ZW1wbGF0ZSB3aWxsIGJlIHVzZWQuXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2JlZHJvY2svbGF0ZXN0L3VzZXJndWlkZS9wcm9tcHQtcGxhY2Vob2xkZXJzLmh0bWxcbiAgICovXG4gIHJlYWRvbmx5IGN1c3RvbVByb21wdFRlbXBsYXRlPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGluZmVyZW5jZSBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgaW5mZXJlbmNlQ29uZmlnPzogSW5mZXJlbmNlQ29uZmlndXJhdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbkN1c3RvbVBhcnNlciBleHRlbmRzIFByb21wdFN0ZXBDb25maWd1cmF0aW9uIHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHRoZSBjdXN0b20gTGFtYmRhIHBhcnNlciBkZWZpbmVkIGZvciB0aGUgc2VxdWVuY2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHVzZUN1c3RvbVBhcnNlcj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tUGFyc2VyUHJvcHMge1xuICAvKlxuICAqIExhbWJkYSBmdW5jdGlvbiB0byB1c2UgYXMgY3VzdG9tIHBhcnNlclxuICAqL1xuICByZWFkb25seSBwYXJzZXI/OiBJRnVuY3Rpb247XG4gIC8qXG4gICogcHJvbXB0IHN0ZXAgY29uZmlndXJhdGlvbnMuIEF0IGxlYXN0IG9uZSBvZiB0aGUgc3RlcHMgbXVzdCBtYWtlIHVzZSBvZiB0aGUgY3VzdG9tIHBhcnNlci5cbiAgKi9cbiAgcmVhZG9ubHkgc3RlcHM/OiBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbkN1c3RvbVBhcnNlcltdO1xufVxuXG5leHBvcnQgY2xhc3MgUHJvbXB0T3ZlcnJpZGVDb25maWd1cmF0aW9uIHtcbiAgcHVibGljIHN0YXRpYyBmcm9tU3RlcHMoc3RlcHM/OiBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbltdKTogUHJvbXB0T3ZlcnJpZGVDb25maWd1cmF0aW9uIHtcbiAgICAvLyBDcmVhdGUgbmV3IG9iamVjdFxuICAgIHJldHVybiBuZXcgUHJvbXB0T3ZlcnJpZGVDb25maWd1cmF0aW9uKHsgc3RlcHMgfSk7XG4gIH1cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBQcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb24gd2l0aCBhIGN1c3RvbSBMYW1iZGEgcGFyc2VyIGZ1bmN0aW9uLlxuICAgKiBAcGFyYW0gcHJvcHMgQ29uZmlndXJhdGlvbiBpbmNsdWRpbmc6XG4gICAqICAgLSBgcGFyc2VyYDogTGFtYmRhIGZ1bmN0aW9uIHRvIHVzZSBhcyBjdXN0b20gcGFyc2VyXG4gICAqICAgLSBgc3RlcHNgOiBwcm9tcHQgc3RlcCBjb25maWd1cmF0aW9ucy4gQXQgbGVhc3Qgb25lIG9mIHRoZSBzdGVwcyBtdXN0IG1ha2UgdXNlIG9mIHRoZSBjdXN0b20gcGFyc2VyLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyB3aXRoQ3VzdG9tUGFyc2VyKHByb3BzOiBDdXN0b21QYXJzZXJQcm9wcyk6IFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbiB7XG4gICAgLy8gQ3JlYXRlIG5ldyBvYmplY3RcbiAgICByZXR1cm4gbmV3IFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbihwcm9wcyk7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGN1c3RvbSBMYW1iZGEgcGFyc2VyIGZ1bmN0aW9uIHRvIHVzZS5cbiAgICogVGhlIExhbWJkYSBwYXJzZXIgcHJvY2Vzc2VzIGFuZCBpbnRlcnByZXRzIHRoZSByYXcgZm91bmRhdGlvbiBtb2RlbCBvdXRwdXQuXG4gICAqIEl0IHJlY2VpdmVzIGFuIGlucHV0IGV2ZW50IHdpdGg6XG4gICAqIC0gbWVzc2FnZVZlcnNpb246IFZlcnNpb24gb2YgbWVzc2FnZSBmb3JtYXQgKDEuMClcbiAgICogLSBhZ2VudDogSW5mbyBhYm91dCB0aGUgYWdlbnQgKG5hbWUsIGlkLCBhbGlhcywgdmVyc2lvbilcbiAgICogLSBpbnZva2VNb2RlbFJhd1Jlc3BvbnNlOiBSYXcgbW9kZWwgb3V0cHV0IHRvIHBhcnNlXG4gICAqIC0gcHJvbXB0VHlwZTogVHlwZSBvZiBwcm9tcHQgYmVpbmcgcGFyc2VkXG4gICAqIC0gb3ZlcnJpZGVUeXBlOiBUeXBlIG9mIG92ZXJyaWRlIChPVVRQVVRfUEFSU0VSKVxuICAgKlxuICAgKiBUaGUgTGFtYmRhIG11c3QgcmV0dXJuIGEgcmVzcG9uc2UgdGhhdCB0aGUgYWdlbnQgdXNlcyBmb3IgbmV4dCBhY3Rpb25zLlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9iZWRyb2NrL2xhdGVzdC91c2VyZ3VpZGUvbGFtYmRhLXBhcnNlci5odG1sXG4gICAqL1xuICByZWFkb25seSBwYXJzZXI/OiBJRnVuY3Rpb247XG5cbiAgLyoqXG4gICAqIFRoZSBwcm9tcHQgY29uZmlndXJhdGlvbnMgdG8gb3ZlcnJpZGUgdGhlIHByb21wdCB0ZW1wbGF0ZXMgaW4gdGhlIGFnZW50IHNlcXVlbmNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHByb21wdCBjb25maWd1cmF0aW9uIHdpbGwgYmUgb3ZlcnJpZGRlbi5cbiAgICovXG4gIHJlYWRvbmx5IHN0ZXBzPzogUHJvbXB0U3RlcENvbmZpZ3VyYXRpb25DdXN0b21QYXJzZXJbXTtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbi5cbiAgICpcbiAgICogQGludGVybmFsIC0gVGhpcyBpcyBtYXJrZWQgYXMgcHJpdmF0ZSBzbyBlbmQgdXNlcnMgbGV2ZXJhZ2UgaXQgb25seSB0aHJvdWdoIHN0YXRpYyBtZXRob2RzXG4gICAqL1xuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByb3BzOiBDdXN0b21QYXJzZXJQcm9wcykge1xuICAgIC8vIFZhbGlkYXRlIHByb3BzXG4gICAgdmFsaWRhdGlvbi50aHJvd0lmSW52YWxpZCh0aGlzLnZhbGlkYXRlU3RlcHMsIHByb3BzLnN0ZXBzKTtcbiAgICBpZiAocHJvcHMucGFyc2VyKSB7XG4gICAgICB2YWxpZGF0aW9uLnRocm93SWZJbnZhbGlkKHRoaXMudmFsaWRhdGVDdXN0b21QYXJzZXIsIHByb3BzLnN0ZXBzKTtcbiAgICB9XG4gICAgdGhpcy5wYXJzZXIgPSBwcm9wcy5wYXJzZXI7XG4gICAgdGhpcy5zdGVwcyA9IHByb3BzLnN0ZXBzO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvcm1hdCBhcyBDZm5BZ2VudC5Qcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb25Qcm9wZXJ0eVxuICAgKlxuICAgKiBAaW50ZXJuYWwgVGhpcyBpcyBhbiBpbnRlcm5hbCBjb3JlIGZ1bmN0aW9uIGFuZCBzaG91bGQgbm90IGJlIGNhbGxlZCBkaXJlY3RseS5cbiAgICovXG4gIHB1YmxpYyBfcmVuZGVyKCk6IENmbkFnZW50LlByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvblByb3BlcnR5IHtcbiAgICByZXR1cm4ge1xuICAgICAgb3ZlcnJpZGVMYW1iZGE6IHRoaXMucGFyc2VyPy5mdW5jdGlvbkFybixcbiAgICAgIHByb21wdENvbmZpZ3VyYXRpb25zOlxuICAgICAgICB0aGlzLnN0ZXBzPy5tYXAoc3RlcCA9PiAoe1xuICAgICAgICAgIC8vIHByZXR0aWVyLWlnbm9yZVxuICAgICAgICAgIHByb21wdFR5cGU6IHN0ZXAuc3RlcFR5cGUsXG4gICAgICAgICAgLyoqIE1hcHMgc3RlcEVuYWJsZWQgKHRydWUg4oaSICdFTkFCTEVEJywgZmFsc2Ug4oaSICdESVNBQkxFRCcsIHVuZGVmaW5lZCDihpIgdW5kZWZpbmVkICh1c2VzIENGTiBERUZBVUxUKSkgKi9cbiAgICAgICAgICBwcm9tcHRTdGF0ZTogc3RlcD8uc3RlcEVuYWJsZWQgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHN0ZXAuc3RlcEVuYWJsZWQgPyAnRU5BQkxFRCcgOiAnRElTQUJMRUQnLFxuICAgICAgICAgIC8qKiBNYXBzIHN0ZXBFbmFibGVkICh0cnVlIOKGkiAnT1ZFUlJJRERFTicsIGZhbHNlIOKGkiAnREVGQVVMVCcsIHVuZGVmaW5lZCDihpIgdW5kZWZpbmVkICh1c2VzIENGTiBERUZBVUxUKSkgKi9cbiAgICAgICAgICAvLyBwcmV0dGllci1pZ25vcmVcbiAgICAgICAgICBwYXJzZXJNb2RlOlxuICAgICAgICAgICAgc3RlcD8udXNlQ3VzdG9tUGFyc2VyID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgOiBzdGVwPy51c2VDdXN0b21QYXJzZXIgPyAnT1ZFUlJJRERFTicgOiAnREVGQVVMVCcsXG4gICAgICAgICAgLy8gVXNlIGN1c3RvbSBwcm9tcHQgdGVtcGxhdGUgaWYgcHJvdmlkZWQsIG90aGVyd2lzZSB1c2UgZGVmYXVsdFxuICAgICAgICAgIC8vIHByZXR0aWVyLWlnbm9yZVxuICAgICAgICAgIHByb21wdENyZWF0aW9uTW9kZTogc3RlcD8uY3VzdG9tUHJvbXB0VGVtcGxhdGUgPT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgIDogc3RlcD8uY3VzdG9tUHJvbXB0VGVtcGxhdGUgPyAnT1ZFUlJJRERFTicgOiAnREVGQVVMVCcsXG4gICAgICAgICAgYmFzZVByb21wdFRlbXBsYXRlOiBzdGVwLmN1c3RvbVByb21wdFRlbXBsYXRlLFxuICAgICAgICAgIGluZmVyZW5jZUNvbmZpZ3VyYXRpb246IHN0ZXAuaW5mZXJlbmNlQ29uZmlnLFxuICAgICAgICB9KSkgfHwgW10sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVJbmZlcmVuY2VDb25maWcgPSAoY29uZmlnPzogSW5mZXJlbmNlQ29uZmlndXJhdGlvbik6IHN0cmluZ1tdID0+IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICBpZiAoY29uZmlnLnRlbXBlcmF0dXJlIDwgMCB8fCBjb25maWcudGVtcGVyYXR1cmUgPiAxKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdUZW1wZXJhdHVyZSBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMScpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbmZpZy50b3BQIDwgMCB8fCBjb25maWcudG9wUCA+IDEpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ1RvcFAgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEnKTtcbiAgICAgIH1cbiAgICAgIGlmIChjb25maWcudG9wSyA8IDAgfHwgY29uZmlnLnRvcEsgPiA1MDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ1RvcEsgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDUwMCcpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbmZpZy5zdG9wU2VxdWVuY2VzLmxlbmd0aCA+IDQpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ01heGltdW0gNCBzdG9wIHNlcXVlbmNlcyBhbGxvd2VkJyk7XG4gICAgICB9XG4gICAgICBpZiAoY29uZmlnLm1heGltdW1MZW5ndGggPCAwIHx8IGNvbmZpZy5tYXhpbXVtTGVuZ3RoID4gNDA5Nikge1xuICAgICAgICBlcnJvcnMucHVzaCgnTWF4aW11bUxlbmd0aCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgNDA5NicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlcnJvcnM7XG4gIH07XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVN0ZXBzID0gKHN0ZXBzPzogUHJvbXB0U3RlcENvbmZpZ3VyYXRpb25bXSk6IHN0cmluZ1tdID0+IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAoIXN0ZXBzIHx8IHN0ZXBzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgZXJyb3JzLnB1c2goJ1N0ZXBzIGFycmF5IGNhbm5vdCBiZSBlbXB0eScpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGVhY2ggc3RlcCdzIGluZmVyZW5jZSBjb25maWdcbiAgICBzdGVwcz8uZm9yRWFjaChzdGVwID0+IHtcbiAgICAgIGNvbnN0IGluZmVyZW5jZUVycm9ycyA9IHRoaXMudmFsaWRhdGVJbmZlcmVuY2VDb25maWcoc3RlcC5pbmZlcmVuY2VDb25maWcpO1xuICAgICAgaWYgKGluZmVyZW5jZUVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGBTdGVwICR7c3RlcC5zdGVwVHlwZX06ICR7aW5mZXJlbmNlRXJyb3JzLmpvaW4oJywgJyl9YCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZXJyb3JzO1xuICB9O1xuXG4gIHByaXZhdGUgdmFsaWRhdGVDdXN0b21QYXJzZXIgPSAoc3RlcHM/OiBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbkN1c3RvbVBhcnNlcltdKTogc3RyaW5nW10gPT4ge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAgIGNvbnN0IGhhc0N1c3RvbVBhcnNlciA9IHN0ZXBzPy5zb21lKHN0ZXAgPT4gc3RlcC51c2VDdXN0b21QYXJzZXIpO1xuICAgIGlmICghaGFzQ3VzdG9tUGFyc2VyKSB7XG4gICAgICBlcnJvcnMucHVzaCgnQXQgbGVhc3Qgb25lIHN0ZXAgbXVzdCB1c2UgY3VzdG9tIHBhcnNlcicpO1xuICAgIH1cblxuICAgIHJldHVybiBlcnJvcnM7XG4gIH07XG59XG4iXX0=