"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateJumpStartModels = generateJumpStartModels;
exports.download_data = download_data;
const fs = require("fs");
const path = require("path");
const zlib = require("zlib");
const generate_utils_1 = require("./generate-utils");
const jumpstart_constants_1 = require("../private/jumpstart-constants");
const JUMPSTART_CACHE_PATH = path.join(__dirname, './.cache/jumpstart-models-cache.json');
const JUMPSTART_MODEL_PATH = path.join(__dirname, '../jumpstart-model.ts');
const JUMPSTART_MODELS_PATH = path.join(__dirname, '../jumpstart-models.json');
const ALLOWED_FRAMEWORKS = [
    'huggingface',
    'huggingface-llm',
    'djl-deepspeed',
    'djl-fastertransformer',
    'stabilityai',
];
async function generateJumpStartModels() {
    console.log('Getting JumpStart models data');
    await download_data();
    generateCode();
}
async function download_data() {
    console.log('Downloading JumpStart models data');
    const regions = jumpstart_constants_1.JumpStartConstants.JUMPSTART_LAUNCHED_REGIONS;
    const regionNames = Object.keys(regions).filter((c) => c === 'us-east-1');
    const models = {};
    const frameworks = new Set();
    for (const regionName of regionNames) {
        console.log(`Processing region ${regionName}`);
        const regionData = regions[regionName];
        const manifestS3Key = jumpstart_constants_1.JumpStartConstants.JUMPSTART_DEFAULT_MANIFEST_FILE_S3_KEY;
        const url = `https://${regionData.contentBucket}.s3.${regionName}.amazonaws.com/${manifestS3Key}`;
        const [manifest] = await generate_utils_1.GenerateUtils.downloadJSON(url);
        for (const model of manifest) {
            const specUrl = `https://${regionData.contentBucket}.s3.${regionName}.amazonaws.com/${model.spec_key}`;
            const [modelSpec] = await generate_utils_1.GenerateUtils.downloadJSON(specUrl);
            const { deprecated, hosting_ecr_specs, default_inference_instance_type, supported_inference_instance_types, hosting_model_package_arns, hosting_use_script_uri, hosting_script_key, hosting_artifact_key, hosting_prepacked_artifact_key, gated_bucket, inference_environment_variables, hosting_instance_type_variants, hosting_eula_key, } = modelSpec;
            const allowedFramework = ALLOWED_FRAMEWORKS.includes(hosting_ecr_specs.framework);
            console.log(`${deprecated ? '[DEPRECATED] ' : ''}${!allowedFramework ? '[SKIP:' + hosting_ecr_specs.framework + '] ' : ''}${model.model_id}/${model.version}`);
            frameworks.add(hosting_ecr_specs.framework);
            if (deprecated)
                continue;
            if (!ALLOWED_FRAMEWORKS.includes(hosting_ecr_specs.framework))
                continue;
            if (hosting_use_script_uri ||
                (!hosting_prepacked_artifact_key && !hosting_model_package_arns && !hosting_artifact_key)) {
                throw new Error('No model data');
            }
            models[model.model_id] = models[model.model_id] ?? {};
            models[model.model_id][model.version] = models[model.model_id][model.version] ?? {};
            models[model.model_id][model.version] = {
                deprecated,
                hosting_ecr_specs,
                default_inference_instance_type,
                supported_inference_instance_types,
                hosting_model_package_arns,
                hosting_use_script_uri,
                hosting_artifact_key,
                hosting_script_key,
                hosting_prepacked_artifact_key,
                gated_bucket,
                inference_environment_variables,
                hosting_instance_type_variants,
                hosting_eula_key,
            };
        }
    }
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_CACHE_PATH, JSON.stringify(models));
    console.log('Frameworks', Array.from(frameworks));
}
function generateCode() {
    console.log('Generating JumpStart models data');
    const data = JSON.parse(fs.readFileSync(JUMPSTART_CACHE_PATH, 'utf8'));
    let modelsStr = '';
    let specs = {};
    for (const modelId of Object.keys(data)) {
        for (const version of Object.keys(data[modelId])) {
            const modelName = `${generate_utils_1.GenerateUtils.replaceAll(modelId, '-', '_')}_${generate_utils_1.GenerateUtils.replaceAll(version, '\\.', '_')}`.toUpperCase();
            const specSource = data[modelId][version];
            const environment = {};
            for (const env of specSource.inference_environment_variables) {
                environment[env.name] = env.default;
            }
            const hosting_eula_key = specSource.hosting_eula_key;
            const instanceVariants = specSource.hosting_instance_type_variants?.variants;
            const instanceAliases = specSource.hosting_instance_type_variants?.regional_aliases;
            let instanceVariantsArr;
            let instanceAliasesArr;
            if (instanceVariants) {
                instanceVariantsArr = [];
                for (const instanceType of Object.keys(instanceVariants)) {
                    const current = instanceVariants[instanceType];
                    instanceVariantsArr.push({
                        instanceType,
                        imageUri: current.regional_properties?.image_uri,
                        environment: current.properties?.environment_variables,
                    });
                }
            }
            if (instanceAliases) {
                instanceAliasesArr = [];
                for (const region of Object.keys(instanceAliases)) {
                    const current = instanceAliases[region];
                    instanceAliasesArr.push({
                        region,
                        aliases: current,
                    });
                }
            }
            const spec = {
                modelId,
                version,
                defaultInstanceType: specSource.default_inference_instance_type,
                instanceTypes: specSource.supported_inference_instance_types,
                modelPackageArns: specSource.hosting_model_package_arns,
                prepackedArtifactKey: specSource.hosting_prepacked_artifact_key,
                gatedBucket: specSource.gated_bucket,
                artifactKey: specSource.hosting_artifact_key,
                environment,
                instanceAliases: instanceAliasesArr,
                instanceVariants: instanceVariantsArr,
                requiresEula: hosting_eula_key,
            };
            if (spec.modelPackageArns) {
                delete spec.artifactKey;
                delete spec.prepackedArtifactKey;
            }
            specs[modelName] = spec;
            modelsStr += '  ' + `public static readonly ${modelName} = this.of('${modelName}');\n`;
        }
    }
    const fileStr = `/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
import * as zlib from 'zlib';
import * as data from './jumpstart-models.json';

export interface IInstanceAliase {
  region: string;
  aliases: { [key: string]: string };
}

export interface IInstanceValiant {
  instanceType: string;
  imageUri?: string;
  environment?: { [key: string]: string };
}

export interface IJumpStartModelSpec {
  modelId: string;
  version: string;
  defaultInstanceType: string;
  instanceTypes: string[];
  modelPackageArns?: { [region: string]: string };
  prepackedArtifactKey?: string;
  gatedBucket: boolean;
  artifactKey?: string;
  environment: { [key: string]: string | number | boolean };
  instanceAliases?: IInstanceAliase[];
  instanceVariants?: IInstanceValiant[];
  requiresEula: boolean;
}

export class JumpStartModel {
${modelsStr}

  public static of(name: string): JumpStartModel {
    return new JumpStartModel(name);
  }

  constructor(private readonly name: string) {}

  public bind(): IJumpStartModelSpec {
    const bufferSource = (data as { data: number[] }).data;
    const buffer = Buffer.from(bufferSource);
    const bufferStr = zlib.inflateRawSync(buffer);
    const json = JSON.parse(bufferStr.toString());

    return json[this.name];
  }
}`;
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_MODELS_PATH, JSON.stringify(zlib.deflateRawSync(JSON.stringify(specs)).toJSON()));
    generate_utils_1.GenerateUtils.writeFileSyncWithDirs(JUMPSTART_MODEL_PATH, fileStr);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtanVtcHN0YXJ0LW1vZGVscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9wYXR0ZXJucy9nZW4tYWkvYXdzLW1vZGVsLWRlcGxveW1lbnQtc2FnZW1ha2VyL2NvZGUtZ2VuZXJhdGlvbi9nZW5lcmF0ZS1qdW1wc3RhcnQtbW9kZWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7QUFzRUgsMERBS0M7QUFFRCxzQ0E2RUM7QUF4SkQseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3Qiw2QkFBNkI7QUFDN0IscURBQWlEO0FBQ2pELHdFQUFvRTtBQW9EcEUsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO0FBQzFGLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztBQUMzRSxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDBCQUEwQixDQUFDLENBQUM7QUFFL0UsTUFBTSxrQkFBa0IsR0FBRztJQUN6QixhQUFhO0lBQ2IsaUJBQWlCO0lBQ2pCLGVBQWU7SUFDZix1QkFBdUI7SUFDdkIsYUFBYTtDQUNkLENBQUM7QUFFSyxLQUFLLFVBQVUsdUJBQXVCO0lBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUU3QyxNQUFNLGFBQWEsRUFBRSxDQUFDO0lBQ3RCLFlBQVksRUFBRSxDQUFDO0FBQ2pCLENBQUM7QUFFTSxLQUFLLFVBQVUsYUFBYTtJQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7SUFFakQsTUFBTSxPQUFPLEdBQUcsd0NBQWtCLENBQUMsMEJBQTBCLENBQUM7SUFDOUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxXQUFXLENBQUMsQ0FBQztJQUMxRSxNQUFNLE1BQU0sR0FBZSxFQUFFLENBQUM7SUFDOUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztJQUVyQyxLQUFLLE1BQU0sVUFBVSxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDL0MsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sYUFBYSxHQUFHLHdDQUFrQixDQUFDLHNDQUFzQyxDQUFDO1FBQ2hGLE1BQU0sR0FBRyxHQUFHLFdBQVcsVUFBVSxDQUFDLGFBQWEsT0FBTyxVQUFVLGtCQUFrQixhQUFhLEVBQUUsQ0FBQztRQUNsRyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQStCLE1BQU0sOEJBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFckYsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUM3QixNQUFNLE9BQU8sR0FBRyxXQUFXLFVBQVUsQ0FBQyxhQUFhLE9BQU8sVUFBVSxrQkFBa0IsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3ZHLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBeUIsTUFBTSw4QkFBYSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVwRixNQUFNLEVBQ0osVUFBVSxFQUNWLGlCQUFpQixFQUNqQiwrQkFBK0IsRUFDL0Isa0NBQWtDLEVBQ2xDLDBCQUEwQixFQUMxQixzQkFBc0IsRUFDdEIsa0JBQWtCLEVBQ2xCLG9CQUFvQixFQUNwQiw4QkFBOEIsRUFDOUIsWUFBWSxFQUNaLCtCQUErQixFQUMvQiw4QkFBOEIsRUFDOUIsZ0JBQWdCLEdBQ2pCLEdBQUcsU0FBUyxDQUFDO1lBRWQsTUFBTSxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFbEYsT0FBTyxDQUFDLEdBQUcsQ0FDVCxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQ2xDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUN0RSxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUNyQyxDQUFDO1lBRUYsVUFBVSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM1QyxJQUFJLFVBQVU7Z0JBQUUsU0FBUztZQUN6QixJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztnQkFBRSxTQUFTO1lBQ3hFLElBQ0Usc0JBQXNCO2dCQUN0QixDQUFDLENBQUMsOEJBQThCLElBQUksQ0FBQywwQkFBMEIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQ3pGLENBQUM7Z0JBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNuQyxDQUFDO1lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN0RCxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFcEYsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUc7Z0JBQ3RDLFVBQVU7Z0JBQ1YsaUJBQWlCO2dCQUNqQiwrQkFBK0I7Z0JBQy9CLGtDQUFrQztnQkFDbEMsMEJBQTBCO2dCQUMxQixzQkFBc0I7Z0JBQ3RCLG9CQUFvQjtnQkFDcEIsa0JBQWtCO2dCQUNsQiw4QkFBOEI7Z0JBQzlCLFlBQVk7Z0JBQ1osK0JBQStCO2dCQUMvQiw4QkFBOEI7Z0JBQzlCLGdCQUFnQjthQUNqQixDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRCw4QkFBYSxDQUFDLHFCQUFxQixDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUVsRixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQUVELFNBQVMsWUFBWTtJQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFFaEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLG9CQUFvQixFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFFdkUsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ25CLElBQUksS0FBSyxHQUF3QixFQUFFLENBQUM7SUFFcEMsS0FBSyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDeEMsS0FBSyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDakQsTUFBTSxTQUFTLEdBQUcsR0FBRyw4QkFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLDhCQUFhLENBQUMsVUFBVSxDQUMxRixPQUFPLEVBQ1AsS0FBSyxFQUNMLEdBQUcsQ0FDSixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzFDLE1BQU0sV0FBVyxHQUFpRCxFQUFFLENBQUM7WUFDckUsS0FBSyxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsK0JBQStCLEVBQUUsQ0FBQztnQkFDN0QsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO1lBQ3RDLENBQUM7WUFFRCxNQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNyRCxNQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyw4QkFBOEIsRUFBRSxRQUFRLENBQUM7WUFDN0UsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLDhCQUE4QixFQUFFLGdCQUFnQixDQUFDO1lBQ3BGLElBQUksbUJBQXNDLENBQUM7WUFDM0MsSUFBSSxrQkFBcUMsQ0FBQztZQUMxQyxJQUFJLGdCQUFnQixFQUFFLENBQUM7Z0JBQ3JCLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztnQkFDekIsS0FBSyxNQUFNLFlBQVksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztvQkFDekQsTUFBTSxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBRS9DLG1CQUFtQixDQUFDLElBQUksQ0FBQzt3QkFDdkIsWUFBWTt3QkFDWixRQUFRLEVBQUUsT0FBTyxDQUFDLG1CQUFtQixFQUFFLFNBQVM7d0JBQ2hELFdBQVcsRUFBRSxPQUFPLENBQUMsVUFBVSxFQUFFLHFCQUFxQjtxQkFDdkQsQ0FBQyxDQUFDO2dCQUNMLENBQUM7WUFDSCxDQUFDO1lBRUQsSUFBSSxlQUFlLEVBQUUsQ0FBQztnQkFDcEIsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO2dCQUN4QixLQUFLLE1BQU0sTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztvQkFDbEQsTUFBTSxPQUFPLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUV4QyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7d0JBQ3RCLE1BQU07d0JBQ04sT0FBTyxFQUFFLE9BQU87cUJBQ2pCLENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQztZQUVELE1BQU0sSUFBSSxHQUFHO2dCQUNYLE9BQU87Z0JBQ1AsT0FBTztnQkFDUCxtQkFBbUIsRUFBRSxVQUFVLENBQUMsK0JBQStCO2dCQUMvRCxhQUFhLEVBQUUsVUFBVSxDQUFDLGtDQUFrQztnQkFDNUQsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLDBCQUEwQjtnQkFDdkQsb0JBQW9CLEVBQUUsVUFBVSxDQUFDLDhCQUE4QjtnQkFDL0QsV0FBVyxFQUFFLFVBQVUsQ0FBQyxZQUFZO2dCQUNwQyxXQUFXLEVBQUUsVUFBVSxDQUFDLG9CQUFvQjtnQkFDNUMsV0FBVztnQkFDWCxlQUFlLEVBQUUsa0JBQWtCO2dCQUNuQyxnQkFBZ0IsRUFBRSxtQkFBbUI7Z0JBQ3JDLFlBQVksRUFBRSxnQkFBZ0I7YUFDL0IsQ0FBQztZQUVGLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7Z0JBQzFCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFDeEIsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUM7WUFDbkMsQ0FBQztZQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDeEIsU0FBUyxJQUFJLElBQUksR0FBRywwQkFBMEIsU0FBUyxlQUFlLFNBQVMsT0FBTyxDQUFDO1FBQ3pGLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztFQTBDaEIsU0FBUzs7Ozs7Ozs7Ozs7Ozs7OztFQWdCVCxDQUFDO0lBRUQsOEJBQWEsQ0FBQyxxQkFBcUIsQ0FDakMscUJBQXFCLEVBQ3JCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FDcEUsQ0FBQztJQUNGLDhCQUFhLENBQUMscUJBQXFCLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB6bGliIGZyb20gJ3psaWInO1xuaW1wb3J0IHsgR2VuZXJhdGVVdGlscyB9IGZyb20gJy4vZ2VuZXJhdGUtdXRpbHMnO1xuaW1wb3J0IHsgSnVtcFN0YXJ0Q29uc3RhbnRzIH0gZnJvbSAnLi4vcHJpdmF0ZS9qdW1wc3RhcnQtY29uc3RhbnRzJztcblxuaW50ZXJmYWNlIEp1bXBTdGFydE1vZGVsTWFuaWZlc3Qge1xuICBtb2RlbF9pZDogc3RyaW5nO1xuICB2ZXJzaW9uOiBzdHJpbmc7XG4gIHNwZWNfa2V5OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBKdW1wU3RhcnRNb2RlbFNwZWMge1xuICBkZXByZWNhdGVkOiBib29sZWFuO1xuICBob3N0aW5nX2Vjcl9zcGVjczoge1xuICAgIGZyYW1ld29yazogc3RyaW5nO1xuICB9O1xuICBkZWZhdWx0X2luZmVyZW5jZV9pbnN0YW5jZV90eXBlOiBzdHJpbmc7XG4gIHN1cHBvcnRlZF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZXM6IHN0cmluZ1tdO1xuICBob3N0aW5nX21vZGVsX3BhY2thZ2VfYXJucz86IHsgW3JlZ2lvbjogc3RyaW5nXTogc3RyaW5nIH07XG4gIGhvc3RpbmdfdXNlX3NjcmlwdF91cmk6IHN0cmluZztcbiAgaG9zdGluZ19hcnRpZmFjdF9rZXk/OiBzdHJpbmc7XG4gIGhvc3Rpbmdfc2NyaXB0X2tleT86IHN0cmluZztcbiAgaG9zdGluZ19wcmVwYWNrZWRfYXJ0aWZhY3Rfa2V5Pzogc3RyaW5nO1xuICBnYXRlZF9idWNrZXQ6IGJvb2xlYW47XG4gIGhvc3RpbmdfZXVsYV9rZXk/OiBzdHJpbmc7XG4gIGluZmVyZW5jZV9lbnZpcm9ubWVudF92YXJpYWJsZXM6IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIGRlZmF1bHQ6IHN0cmluZztcbiAgICBzY29wZTogc3RyaW5nO1xuICAgIHJlcXVpcmVkX2Zvcl9tb2RlbF9jbGFzczogYm9vbGVhbjtcbiAgfVtdO1xuICBob3N0aW5nX2luc3RhbmNlX3R5cGVfdmFyaWFudHM/OiB7XG4gICAgcmVnaW9uYWxfYWxpYXNlcz86IHsgW3JlZ2lvbjogc3RyaW5nXTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSB9O1xuICAgIHZhcmlhbnRzOiB7XG4gICAgICBba2V5OiBzdHJpbmddOiB7XG4gICAgICAgIHJlZ2lvbmFsX3Byb3BlcnRpZXM/OiB7XG4gICAgICAgICAgaW1hZ2VfdXJpOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgICAgIHByb3BlcnRpZXM/OiB7XG4gICAgICAgICAgZW52aXJvbm1lbnRfdmFyaWFibGVzOiB7XG4gICAgICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG4gICAgICAgICAgfTtcbiAgICAgICAgfTtcbiAgICAgIH07XG4gICAgfTtcbiAgfTtcbn1cblxuaW50ZXJmYWNlIE1vZGVsc0RhdGEge1xuICBbbW9kZWxJZDogc3RyaW5nXToge1xuICAgIFt2ZXJzaW9uOiBzdHJpbmddOiBKdW1wU3RhcnRNb2RlbFNwZWM7XG4gIH07XG59XG5cbmNvbnN0IEpVTVBTVEFSVF9DQUNIRV9QQVRIID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4vLmNhY2hlL2p1bXBzdGFydC1tb2RlbHMtY2FjaGUuanNvbicpO1xuY29uc3QgSlVNUFNUQVJUX01PREVMX1BBVEggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vanVtcHN0YXJ0LW1vZGVsLnRzJyk7XG5jb25zdCBKVU1QU1RBUlRfTU9ERUxTX1BBVEggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vanVtcHN0YXJ0LW1vZGVscy5qc29uJyk7XG5cbmNvbnN0IEFMTE9XRURfRlJBTUVXT1JLUyA9IFtcbiAgJ2h1Z2dpbmdmYWNlJyxcbiAgJ2h1Z2dpbmdmYWNlLWxsbScsXG4gICdkamwtZGVlcHNwZWVkJyxcbiAgJ2RqbC1mYXN0ZXJ0cmFuc2Zvcm1lcicsXG4gICdzdGFiaWxpdHlhaScsXG5dO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVKdW1wU3RhcnRNb2RlbHMoKSB7XG4gIGNvbnNvbGUubG9nKCdHZXR0aW5nIEp1bXBTdGFydCBtb2RlbHMgZGF0YScpO1xuXG4gIGF3YWl0IGRvd25sb2FkX2RhdGEoKTtcbiAgZ2VuZXJhdGVDb2RlKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkb3dubG9hZF9kYXRhKCkge1xuICBjb25zb2xlLmxvZygnRG93bmxvYWRpbmcgSnVtcFN0YXJ0IG1vZGVscyBkYXRhJyk7XG5cbiAgY29uc3QgcmVnaW9ucyA9IEp1bXBTdGFydENvbnN0YW50cy5KVU1QU1RBUlRfTEFVTkNIRURfUkVHSU9OUztcbiAgY29uc3QgcmVnaW9uTmFtZXMgPSBPYmplY3Qua2V5cyhyZWdpb25zKS5maWx0ZXIoKGMpID0+IGMgPT09ICd1cy1lYXN0LTEnKTtcbiAgY29uc3QgbW9kZWxzOiBNb2RlbHNEYXRhID0ge307XG4gIGNvbnN0IGZyYW1ld29ya3MgPSBuZXcgU2V0PHN0cmluZz4oKTtcblxuICBmb3IgKGNvbnN0IHJlZ2lvbk5hbWUgb2YgcmVnaW9uTmFtZXMpIHtcbiAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyByZWdpb24gJHtyZWdpb25OYW1lfWApO1xuICAgIGNvbnN0IHJlZ2lvbkRhdGEgPSByZWdpb25zW3JlZ2lvbk5hbWVdO1xuICAgIGNvbnN0IG1hbmlmZXN0UzNLZXkgPSBKdW1wU3RhcnRDb25zdGFudHMuSlVNUFNUQVJUX0RFRkFVTFRfTUFOSUZFU1RfRklMRV9TM19LRVk7XG4gICAgY29uc3QgdXJsID0gYGh0dHBzOi8vJHtyZWdpb25EYXRhLmNvbnRlbnRCdWNrZXR9LnMzLiR7cmVnaW9uTmFtZX0uYW1hem9uYXdzLmNvbS8ke21hbmlmZXN0UzNLZXl9YDtcbiAgICBjb25zdCBbbWFuaWZlc3RdOiBbSnVtcFN0YXJ0TW9kZWxNYW5pZmVzdFtdXSA9IGF3YWl0IEdlbmVyYXRlVXRpbHMuZG93bmxvYWRKU09OKHVybCk7XG5cbiAgICBmb3IgKGNvbnN0IG1vZGVsIG9mIG1hbmlmZXN0KSB7XG4gICAgICBjb25zdCBzcGVjVXJsID0gYGh0dHBzOi8vJHtyZWdpb25EYXRhLmNvbnRlbnRCdWNrZXR9LnMzLiR7cmVnaW9uTmFtZX0uYW1hem9uYXdzLmNvbS8ke21vZGVsLnNwZWNfa2V5fWA7XG4gICAgICBjb25zdCBbbW9kZWxTcGVjXTogW0p1bXBTdGFydE1vZGVsU3BlY10gPSBhd2FpdCBHZW5lcmF0ZVV0aWxzLmRvd25sb2FkSlNPTihzcGVjVXJsKTtcblxuICAgICAgY29uc3Qge1xuICAgICAgICBkZXByZWNhdGVkLFxuICAgICAgICBob3N0aW5nX2Vjcl9zcGVjcyxcbiAgICAgICAgZGVmYXVsdF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZSxcbiAgICAgICAgc3VwcG9ydGVkX2luZmVyZW5jZV9pbnN0YW5jZV90eXBlcyxcbiAgICAgICAgaG9zdGluZ19tb2RlbF9wYWNrYWdlX2FybnMsXG4gICAgICAgIGhvc3RpbmdfdXNlX3NjcmlwdF91cmksXG4gICAgICAgIGhvc3Rpbmdfc2NyaXB0X2tleSxcbiAgICAgICAgaG9zdGluZ19hcnRpZmFjdF9rZXksXG4gICAgICAgIGhvc3RpbmdfcHJlcGFja2VkX2FydGlmYWN0X2tleSxcbiAgICAgICAgZ2F0ZWRfYnVja2V0LFxuICAgICAgICBpbmZlcmVuY2VfZW52aXJvbm1lbnRfdmFyaWFibGVzLFxuICAgICAgICBob3N0aW5nX2luc3RhbmNlX3R5cGVfdmFyaWFudHMsXG4gICAgICAgIGhvc3RpbmdfZXVsYV9rZXksXG4gICAgICB9ID0gbW9kZWxTcGVjO1xuXG4gICAgICBjb25zdCBhbGxvd2VkRnJhbWV3b3JrID0gQUxMT1dFRF9GUkFNRVdPUktTLmluY2x1ZGVzKGhvc3RpbmdfZWNyX3NwZWNzLmZyYW1ld29yayk7XG5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgJHtkZXByZWNhdGVkID8gJ1tERVBSRUNBVEVEXSAnIDogJyd9JHtcbiAgICAgICAgICAhYWxsb3dlZEZyYW1ld29yayA/ICdbU0tJUDonICsgaG9zdGluZ19lY3Jfc3BlY3MuZnJhbWV3b3JrICsgJ10gJyA6ICcnXG4gICAgICAgIH0ke21vZGVsLm1vZGVsX2lkfS8ke21vZGVsLnZlcnNpb259YCxcbiAgICAgICk7XG5cbiAgICAgIGZyYW1ld29ya3MuYWRkKGhvc3RpbmdfZWNyX3NwZWNzLmZyYW1ld29yayk7XG4gICAgICBpZiAoZGVwcmVjYXRlZCkgY29udGludWU7XG4gICAgICBpZiAoIUFMTE9XRURfRlJBTUVXT1JLUy5pbmNsdWRlcyhob3N0aW5nX2Vjcl9zcGVjcy5mcmFtZXdvcmspKSBjb250aW51ZTtcbiAgICAgIGlmIChcbiAgICAgICAgaG9zdGluZ191c2Vfc2NyaXB0X3VyaSB8fFxuICAgICAgICAoIWhvc3RpbmdfcHJlcGFja2VkX2FydGlmYWN0X2tleSAmJiAhaG9zdGluZ19tb2RlbF9wYWNrYWdlX2FybnMgJiYgIWhvc3RpbmdfYXJ0aWZhY3Rfa2V5KVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gbW9kZWwgZGF0YScpO1xuICAgICAgfVxuXG4gICAgICBtb2RlbHNbbW9kZWwubW9kZWxfaWRdID0gbW9kZWxzW21vZGVsLm1vZGVsX2lkXSA/PyB7fTtcbiAgICAgIG1vZGVsc1ttb2RlbC5tb2RlbF9pZF1bbW9kZWwudmVyc2lvbl0gPSBtb2RlbHNbbW9kZWwubW9kZWxfaWRdW21vZGVsLnZlcnNpb25dID8/IHt9O1xuXG4gICAgICBtb2RlbHNbbW9kZWwubW9kZWxfaWRdW21vZGVsLnZlcnNpb25dID0ge1xuICAgICAgICBkZXByZWNhdGVkLFxuICAgICAgICBob3N0aW5nX2Vjcl9zcGVjcyxcbiAgICAgICAgZGVmYXVsdF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZSxcbiAgICAgICAgc3VwcG9ydGVkX2luZmVyZW5jZV9pbnN0YW5jZV90eXBlcyxcbiAgICAgICAgaG9zdGluZ19tb2RlbF9wYWNrYWdlX2FybnMsXG4gICAgICAgIGhvc3RpbmdfdXNlX3NjcmlwdF91cmksXG4gICAgICAgIGhvc3RpbmdfYXJ0aWZhY3Rfa2V5LFxuICAgICAgICBob3N0aW5nX3NjcmlwdF9rZXksXG4gICAgICAgIGhvc3RpbmdfcHJlcGFja2VkX2FydGlmYWN0X2tleSxcbiAgICAgICAgZ2F0ZWRfYnVja2V0LFxuICAgICAgICBpbmZlcmVuY2VfZW52aXJvbm1lbnRfdmFyaWFibGVzLFxuICAgICAgICBob3N0aW5nX2luc3RhbmNlX3R5cGVfdmFyaWFudHMsXG4gICAgICAgIGhvc3RpbmdfZXVsYV9rZXksXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIEdlbmVyYXRlVXRpbHMud3JpdGVGaWxlU3luY1dpdGhEaXJzKEpVTVBTVEFSVF9DQUNIRV9QQVRILCBKU09OLnN0cmluZ2lmeShtb2RlbHMpKTtcblxuICBjb25zb2xlLmxvZygnRnJhbWV3b3JrcycsIEFycmF5LmZyb20oZnJhbWV3b3JrcykpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUNvZGUoKSB7XG4gIGNvbnNvbGUubG9nKCdHZW5lcmF0aW5nIEp1bXBTdGFydCBtb2RlbHMgZGF0YScpO1xuXG4gIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhKVU1QU1RBUlRfQ0FDSEVfUEFUSCwgJ3V0ZjgnKSk7XG5cbiAgbGV0IG1vZGVsc1N0ciA9ICcnO1xuICBsZXQgc3BlY3M6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBmb3IgKGNvbnN0IG1vZGVsSWQgb2YgT2JqZWN0LmtleXMoZGF0YSkpIHtcbiAgICBmb3IgKGNvbnN0IHZlcnNpb24gb2YgT2JqZWN0LmtleXMoZGF0YVttb2RlbElkXSkpIHtcbiAgICAgIGNvbnN0IG1vZGVsTmFtZSA9IGAke0dlbmVyYXRlVXRpbHMucmVwbGFjZUFsbChtb2RlbElkLCAnLScsICdfJyl9XyR7R2VuZXJhdGVVdGlscy5yZXBsYWNlQWxsKFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAnXFxcXC4nLFxuICAgICAgICAnXycsXG4gICAgICApfWAudG9VcHBlckNhc2UoKTtcblxuICAgICAgY29uc3Qgc3BlY1NvdXJjZSA9IGRhdGFbbW9kZWxJZF1bdmVyc2lvbl07XG4gICAgICBjb25zdCBlbnZpcm9ubWVudDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIH0gPSB7fTtcbiAgICAgIGZvciAoY29uc3QgZW52IG9mIHNwZWNTb3VyY2UuaW5mZXJlbmNlX2Vudmlyb25tZW50X3ZhcmlhYmxlcykge1xuICAgICAgICBlbnZpcm9ubWVudFtlbnYubmFtZV0gPSBlbnYuZGVmYXVsdDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaG9zdGluZ19ldWxhX2tleSA9IHNwZWNTb3VyY2UuaG9zdGluZ19ldWxhX2tleTtcbiAgICAgIGNvbnN0IGluc3RhbmNlVmFyaWFudHMgPSBzcGVjU291cmNlLmhvc3RpbmdfaW5zdGFuY2VfdHlwZV92YXJpYW50cz8udmFyaWFudHM7XG4gICAgICBjb25zdCBpbnN0YW5jZUFsaWFzZXMgPSBzcGVjU291cmNlLmhvc3RpbmdfaW5zdGFuY2VfdHlwZV92YXJpYW50cz8ucmVnaW9uYWxfYWxpYXNlcztcbiAgICAgIGxldCBpbnN0YW5jZVZhcmlhbnRzQXJyOiBhbnlbXSB8IHVuZGVmaW5lZDtcbiAgICAgIGxldCBpbnN0YW5jZUFsaWFzZXNBcnI6IGFueVtdIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKGluc3RhbmNlVmFyaWFudHMpIHtcbiAgICAgICAgaW5zdGFuY2VWYXJpYW50c0FyciA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGluc3RhbmNlVHlwZSBvZiBPYmplY3Qua2V5cyhpbnN0YW5jZVZhcmlhbnRzKSkge1xuICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBpbnN0YW5jZVZhcmlhbnRzW2luc3RhbmNlVHlwZV07XG5cbiAgICAgICAgICBpbnN0YW5jZVZhcmlhbnRzQXJyLnB1c2goe1xuICAgICAgICAgICAgaW5zdGFuY2VUeXBlLFxuICAgICAgICAgICAgaW1hZ2VVcmk6IGN1cnJlbnQucmVnaW9uYWxfcHJvcGVydGllcz8uaW1hZ2VfdXJpLFxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IGN1cnJlbnQucHJvcGVydGllcz8uZW52aXJvbm1lbnRfdmFyaWFibGVzLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChpbnN0YW5jZUFsaWFzZXMpIHtcbiAgICAgICAgaW5zdGFuY2VBbGlhc2VzQXJyID0gW107XG4gICAgICAgIGZvciAoY29uc3QgcmVnaW9uIG9mIE9iamVjdC5rZXlzKGluc3RhbmNlQWxpYXNlcykpIHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50ID0gaW5zdGFuY2VBbGlhc2VzW3JlZ2lvbl07XG5cbiAgICAgICAgICBpbnN0YW5jZUFsaWFzZXNBcnIucHVzaCh7XG4gICAgICAgICAgICByZWdpb24sXG4gICAgICAgICAgICBhbGlhc2VzOiBjdXJyZW50LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNwZWMgPSB7XG4gICAgICAgIG1vZGVsSWQsXG4gICAgICAgIHZlcnNpb24sXG4gICAgICAgIGRlZmF1bHRJbnN0YW5jZVR5cGU6IHNwZWNTb3VyY2UuZGVmYXVsdF9pbmZlcmVuY2VfaW5zdGFuY2VfdHlwZSxcbiAgICAgICAgaW5zdGFuY2VUeXBlczogc3BlY1NvdXJjZS5zdXBwb3J0ZWRfaW5mZXJlbmNlX2luc3RhbmNlX3R5cGVzLFxuICAgICAgICBtb2RlbFBhY2thZ2VBcm5zOiBzcGVjU291cmNlLmhvc3RpbmdfbW9kZWxfcGFja2FnZV9hcm5zLFxuICAgICAgICBwcmVwYWNrZWRBcnRpZmFjdEtleTogc3BlY1NvdXJjZS5ob3N0aW5nX3ByZXBhY2tlZF9hcnRpZmFjdF9rZXksXG4gICAgICAgIGdhdGVkQnVja2V0OiBzcGVjU291cmNlLmdhdGVkX2J1Y2tldCxcbiAgICAgICAgYXJ0aWZhY3RLZXk6IHNwZWNTb3VyY2UuaG9zdGluZ19hcnRpZmFjdF9rZXksXG4gICAgICAgIGVudmlyb25tZW50LFxuICAgICAgICBpbnN0YW5jZUFsaWFzZXM6IGluc3RhbmNlQWxpYXNlc0FycixcbiAgICAgICAgaW5zdGFuY2VWYXJpYW50czogaW5zdGFuY2VWYXJpYW50c0FycixcbiAgICAgICAgcmVxdWlyZXNFdWxhOiBob3N0aW5nX2V1bGFfa2V5LFxuICAgICAgfTtcblxuICAgICAgaWYgKHNwZWMubW9kZWxQYWNrYWdlQXJucykge1xuICAgICAgICBkZWxldGUgc3BlYy5hcnRpZmFjdEtleTtcbiAgICAgICAgZGVsZXRlIHNwZWMucHJlcGFja2VkQXJ0aWZhY3RLZXk7XG4gICAgICB9XG5cbiAgICAgIHNwZWNzW21vZGVsTmFtZV0gPSBzcGVjO1xuICAgICAgbW9kZWxzU3RyICs9ICcgICcgKyBgcHVibGljIHN0YXRpYyByZWFkb25seSAke21vZGVsTmFtZX0gPSB0aGlzLm9mKCcke21vZGVsTmFtZX0nKTtcXG5gO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGZpbGVTdHIgPSBgLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cbmltcG9ydCAqIGFzIHpsaWIgZnJvbSAnemxpYic7XG5pbXBvcnQgKiBhcyBkYXRhIGZyb20gJy4vanVtcHN0YXJ0LW1vZGVscy5qc29uJztcblxuZXhwb3J0IGludGVyZmFjZSBJSW5zdGFuY2VBbGlhc2Uge1xuICByZWdpb246IHN0cmluZztcbiAgYWxpYXNlczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJSW5zdGFuY2VWYWxpYW50IHtcbiAgaW5zdGFuY2VUeXBlOiBzdHJpbmc7XG4gIGltYWdlVXJpPzogc3RyaW5nO1xuICBlbnZpcm9ubWVudD86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUp1bXBTdGFydE1vZGVsU3BlYyB7XG4gIG1vZGVsSWQ6IHN0cmluZztcbiAgdmVyc2lvbjogc3RyaW5nO1xuICBkZWZhdWx0SW5zdGFuY2VUeXBlOiBzdHJpbmc7XG4gIGluc3RhbmNlVHlwZXM6IHN0cmluZ1tdO1xuICBtb2RlbFBhY2thZ2VBcm5zPzogeyBbcmVnaW9uOiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcHJlcGFja2VkQXJ0aWZhY3RLZXk/OiBzdHJpbmc7XG4gIGdhdGVkQnVja2V0OiBib29sZWFuO1xuICBhcnRpZmFjdEtleT86IHN0cmluZztcbiAgZW52aXJvbm1lbnQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB9O1xuICBpbnN0YW5jZUFsaWFzZXM/OiBJSW5zdGFuY2VBbGlhc2VbXTtcbiAgaW5zdGFuY2VWYXJpYW50cz86IElJbnN0YW5jZVZhbGlhbnRbXTtcbiAgcmVxdWlyZXNFdWxhOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgSnVtcFN0YXJ0TW9kZWwge1xuJHttb2RlbHNTdHJ9XG5cbiAgcHVibGljIHN0YXRpYyBvZihuYW1lOiBzdHJpbmcpOiBKdW1wU3RhcnRNb2RlbCB7XG4gICAgcmV0dXJuIG5ldyBKdW1wU3RhcnRNb2RlbChuYW1lKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgbmFtZTogc3RyaW5nKSB7fVxuXG4gIHB1YmxpYyBiaW5kKCk6IElKdW1wU3RhcnRNb2RlbFNwZWMge1xuICAgIGNvbnN0IGJ1ZmZlclNvdXJjZSA9IChkYXRhIGFzIHsgZGF0YTogbnVtYmVyW10gfSkuZGF0YTtcbiAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuZnJvbShidWZmZXJTb3VyY2UpO1xuICAgIGNvbnN0IGJ1ZmZlclN0ciA9IHpsaWIuaW5mbGF0ZVJhd1N5bmMoYnVmZmVyKTtcbiAgICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShidWZmZXJTdHIudG9TdHJpbmcoKSk7XG5cbiAgICByZXR1cm4ganNvblt0aGlzLm5hbWVdO1xuICB9XG59YDtcblxuICBHZW5lcmF0ZVV0aWxzLndyaXRlRmlsZVN5bmNXaXRoRGlycyhcbiAgICBKVU1QU1RBUlRfTU9ERUxTX1BBVEgsXG4gICAgSlNPTi5zdHJpbmdpZnkoemxpYi5kZWZsYXRlUmF3U3luYyhKU09OLnN0cmluZ2lmeShzcGVjcykpLnRvSlNPTigpKSxcbiAgKTtcbiAgR2VuZXJhdGVVdGlscy53cml0ZUZpbGVTeW5jV2l0aERpcnMoSlVNUFNUQVJUX01PREVMX1BBVEgsIGZpbGVTdHIpO1xufVxuIl19